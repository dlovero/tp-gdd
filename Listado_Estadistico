
/*TOP 5 CHOFERES CON MAYOR RECAUDACION*/
IF OBJECT_ID('CHOFERES_MAYOR_RECAUDACION','P') IS NOT NULL
	DROP PROCEDURE CHOFERES_MAYOR_RECAUDACION;
GO
CREATE PROCEDURE CHOFERES_MAYOR_RECAUDACION(@QUARTER INT,@AÑO INT)
AS
BEGIN
	SELECT 
	TOP 5
		DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Chofer		AS CHOFER,
		SUM(DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Importe)  AS IMPORTE
	FROM DESCONOCIDOS4.CABECERO_RENDICION
	WHERE DATEPART(QUARTER,DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Fecha) = @QUARTER AND YEAR(DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Fecha) = @AÑO
	GROUP BY DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Chofer
	ORDER BY SUM(DESCONOCIDOS4.CABECERO_RENDICION.Cab_Rend_Importe) DESC
END
GO
/* FIN TOP 5 CHOFERES CON MAYOR RECAUDACION*/

/* TOP 5 Choferes con el viaje más largo realizado*/
IF OBJECT_DEFINITION('CHOFERES_VIAJE_MAS_LARGO','P') IS NOT NULL
	DROP PROCEDURE CHOFERES_VIAJE_MAS_LARGO;
GO
CREATE PROCEDURE CHOFERES_VIAJE_MAS_LARGO(@QUARTER INT,@AÑO INT)
AS
	BEGIN
		SELECT
		TOP 5
			DESCONOCIDOS4.VIAJE.Viaje_Chofer			AS CHOFER,
			DESCONOCIDOS4.VIAJE.Viaje_Nro				AS NUM_VIAJE,
			DESCONOCIDOS4.VIAJE.Viaje_Cantidad_Km		AS KM_RECORRIDOS
		FROM DESCONOCIDOS4.VIAJE
		WHERE DATEPART(QUARTER,DESCONOCIDOS4.VIAJE.Viaje_Fecha_Hora_Inicio) = @QUARTER AND YEAR(DESCONOCIDOS4.VIAJE.Viaje_Fecha_Hora_Inicio) = @AÑO
		ORDER BY DESCONOCIDOS4.VIAJE.Viaje_Cantidad_Km DESC
	END

GO
/* FIN TOP 5 Choferes con el viaje más largo realizado*/


/*TOP 5 CLIENTES CON MAYOR CONSUMO*/

IF OBJECT_ID ('CLIENTES_MAYOR_CONSUMO','P') IS NOT NULL
	DROP PROCEDURE CLIENTES_MAYOR_CONSUMO;
GO
CREATE PROCEDURE CLIENTES_MAYOR_CONSUMO(@QUARTER INT,@AÑO INT)
AS
BEGIN
	SELECT
	TOP 5
		DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Cliente			AS CLIENTE,
		SUM(DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Total_Fac)	AS TOTAL_FACTURADO
	FROM DESCONOCIDOS4.CABECERO_FACTURA
	WHERE DATEPART(QUARTER,DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Fecha) = @QUARTER AND YEAR(DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Fecha) = @AÑO
	GROUP BY DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Cliente
	ORDER BY SUM(DESCONOCIDOS4.CABECERO_FACTURA.Cab_Fac_Total_Fac) DESC
END
/*FIN TOP 5 CLIENTES CON MAYOR CONSUMO*/


/*TOP 5 Cliente que utilizo más veces el mismo automóvil en los viajes que ha realizado*/
--CADA REGISTRO ES UN VIAJE DISTINTO
IF OBJECT_ID('CLIENTES_MAS_VECES_MISMO_AUTO','P') IS NOT NULL
	DROP PROCEDURE CLIENTES_MAS_VECES_MISMO_AUTO;
GO;

CREATE PROCEDURE CLIENTES_MAS_VECES_MISMO_AUTO(@QUARTER INT,@AÑO INT)
AS
BEGIN
	SELECT 
	TOP 5
		DESCONOCIDOS4.VIAJE.Viaje_Cliente		AS CLIENTE,
		DESCONOCIDOS4.VIAJE.Viaje_Automovil		AS AUTOMOVIL,
		COUNT(*)								AS CANT_VIAJES
	FROM DESCONOCIDOS4.VIAJE
	WHERE DATEPART(QUARTER,DESCONOCIDOS4.VIAJE.Viaje_Fecha_Hora_Inicio) = @QUARTER AND YEAR(DESCONOCIDOS4.VIAJE.Viaje_Fecha_Hora_Inicio) = @AÑO
	GROUP BY DESCONOCIDOS4.VIAJE.Viaje_Cliente,DESCONOCIDOS4.VIAJE.Viaje_Automovil
	ORDER BY  CANT_VIAJES DESC
END

